---
import BaseLayout from "@/layouts/BaseLayout.astro";
import directus, { getAssetUrl } from "@/lib/directus";
import { readItems } from "@directus/sdk";

export async function getStaticPaths() {
  let posts: any[] = [];
  try {
    posts = await directus.request(
      readItems("posts", {
        filter: { status: { _eq: "published" } },
      })
    );
  } catch {
    return [];
  }

  return posts.map((post: any) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

function formatDate(date: string) {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.title,
  "description": post.excerpt || `${post.title} - Arcate Labs`,
  "author": {
    "@type": "Person",
    "name": post.author || "Arcate Labs",
  },
  "publisher": {
    "@type": "Organization",
    "name": "Arcate Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://arcatelabs.com/logo.svg",
    },
  },
  ...(post.date_published && { "datePublished": new Date(post.date_published).toISOString() }),
  ...(post.cover_image && { "image": getAssetUrl(post.cover_image) }),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://arcatelabs.com/blog/${post.slug}`,
  },
};
---

<BaseLayout
  title={post.title}
  description={post.excerpt || `${post.title} - Arcate Labs`}
  type="article"
  publishedTime={post.date_published ? new Date(post.date_published) : undefined}
  author={post.author || "Arcate Labs"}
  image={post.cover_image ? getAssetUrl(post.cover_image) : undefined}
  schema={articleSchema}
>
  <article class="container max-w-4xl mx-auto py-20 px-4 sm:px-6">
    <a href="/blog" class="text-sm text-muted-foreground hover:text-foreground transition-colors mb-8 inline-block">&larr; All Posts</a>

    <header class="mb-12">
      <h1 class="text-4xl font-bold tracking-tight md:text-5xl mb-6">{post.title}</h1>
      <div class="flex items-center gap-4">
        {post.author && (
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-semibold shrink-0">
              {post.author.split(" ").map((n: string) => n[0]).join("")}
            </div>
            <div class="flex flex-col">
              <span class="text-sm font-medium text-foreground">{post.author}</span>
              {post.date_published && (
                <time datetime={post.date_published} class="text-xs text-muted-foreground">{formatDate(post.date_published)}</time>
              )}
            </div>
          </div>
        )}
      </div>
      {post.tags && post.tags.length > 0 && (
        <div class="flex gap-2 mt-4">
          {post.tags.map((tag: string) => (
            <span class="rounded-full border px-3 py-1 text-xs font-medium">{tag}</span>
          ))}
        </div>
      )}
    </header>

    {post.cover_image && (
      <img src={getAssetUrl(post.cover_image)} alt={post.title} class="rounded-lg mb-12 w-full" />
    )}

    <div class="prose prose-lg max-w-none dark:prose-invert" set:html={post.content} />
  </article>
</BaseLayout>
